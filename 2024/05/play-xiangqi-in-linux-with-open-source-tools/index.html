<!DOCTYPE html>
<html lang="en-us">
    <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="theme-color" content="dark">
    <title>在Linux环境下使用开源工具玩中国象棋 | WilliamGates&#39; Blog</title>

    <meta property="og:site_name" content="WilliamGates&#39; Blog" />
    <meta property="og:title" content="在Linux环境下使用开源工具玩中国象棋 | WilliamGates&#39; Blog" />
    <meta itemprop="name" content="在Linux环境下使用开源工具玩中国象棋 | WilliamGates&#39; Blog" />
    <meta name="twitter:title" content="在Linux环境下使用开源工具玩中国象棋 | WilliamGates&#39; Blog" />
    <meta name="application-name" content="在Linux环境下使用开源工具玩中国象棋 | WilliamGates&#39; Blog" />


    <meta name="description"
        content="" />
    <meta name="twitter:description"
        content="" />
    <meta itemprop="description"
        content="" />
    <meta property="og:description"
        content="" />

    


    <link rel="shortcut icon" type="image/x-icon" href="/%20favicon.ico" />
    
    <link rel="stylesheet" href="/sass/main.min.ab99ff095f832511e24ffb2fba2b51ad473b2f7e9301d674eba2c6c3a6e8bd81.css">
    
</head>
    <script>
    (function() {
        const colorSchemeKey = 'ThemeColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.userColorScheme = 'dark';
        } else {
            document.documentElement.dataset.userColorScheme = 'light';
        }
    })();
</script>

    <body class="dark">
        <nav class="navbar">
    <div class="container">
        <div class="flex">
            <div>
                <a class="brand" href="/">
                    
                    
                    WilliamGates&#39; Blog
                    </a>
            </div>
            <div class="flex">
                
                <a href="/about/">About</a>
                
                <a href="/links/">Links</a>
                
                <a href="/posts/">Posts</a>
                
                <a href="/index.xml">RSS</a>
                
                <button id="dark-mode-button">
                  <svg class="light" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" focusable="false" width="1em" height="1em" style="-ms-transform: rotate(360deg); -webkit-transform: rotate(360deg); transform: rotate(360deg);" preserveAspectRatio="xMidYMid meet" viewBox="0 0 36 36"><path fill="#FFD983" d="M30.312.776C32 19 20 32 .776 30.312c8.199 7.717 21.091 7.588 29.107-.429C37.9 21.867 38.03 8.975 30.312.776z"/><path d="M30.705 15.915a1.163 1.163 0 1 0 1.643 1.641a1.163 1.163 0 0 0-1.643-1.641zm-16.022 14.38a1.74 1.74 0 0 0 0 2.465a1.742 1.742 0 1 0 0-2.465zm13.968-2.147a2.904 2.904 0 0 1-4.108 0a2.902 2.902 0 0 1 0-4.107a2.902 2.902 0 0 1 4.108 0a2.902 2.902 0 0 1 0 4.107z" fill="#FFCC4D"/><rect x="0" y="0" width="36" height="36" fill="rgba(0, 0, 0, 0)" /></svg>
                  <svg class="dark" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" focusable="false" width="1em" height="1em" style="-ms-transform: rotate(360deg); -webkit-transform: rotate(360deg); transform: rotate(360deg);" preserveAspectRatio="xMidYMid meet" viewBox="0 0 36 36"><path fill="#FFD983" d="M16 2s0-2 2-2s2 2 2 2v2s0 2-2 2s-2-2-2-2V2zm18 14s2 0 2 2s-2 2-2 2h-2s-2 0-2-2s2-2 2-2h2zM4 16s2 0 2 2s-2 2-2 2H2s-2 0-2-2s2-2 2-2h2zm5.121-8.707s1.414 1.414 0 2.828s-2.828 0-2.828 0L4.878 8.708s-1.414-1.414 0-2.829c1.415-1.414 2.829 0 2.829 0l1.414 1.414zm21 21s1.414 1.414 0 2.828s-2.828 0-2.828 0l-1.414-1.414s-1.414-1.414 0-2.828s2.828 0 2.828 0l1.414 1.414zm-.413-18.172s-1.414 1.414-2.828 0s0-2.828 0-2.828l1.414-1.414s1.414-1.414 2.828 0s0 2.828 0 2.828l-1.414 1.414zm-21 21s-1.414 1.414-2.828 0s0-2.828 0-2.828l1.414-1.414s1.414-1.414 2.828 0s0 2.828 0 2.828l-1.414 1.414zM16 32s0-2 2-2s2 2 2 2v2s0 2-2 2s-2-2-2-2v-2z"/><circle fill="#FFD983" cx="18" cy="18" r="10"/><rect x="0" y="0" width="36" height="36" fill="rgba(0, 0, 0, 0)" /></svg>
                </button>
            </div>
            </div>
    </div>
</nav>
        <main>
            
<div class="container">
    <article>
        <header class="article-header">
            <div class="thumb">
                <div>
                    <h1>在Linux环境下使用开源工具玩中国象棋</h1>
                    <div class="post-meta">
                        <div>
                            
                            
                              
                            
                            By William Gates | <time>May 27, 2024</time>
                            | 12 minutes
                        </div>
                        <div class="tags">
                            
                        </div>
                    </div>
                </div>
            </div>
        </header>
    </article>

    <div class="article-post">
    <p>　　中国象棋有悠久的历史，是老少皆宜的棋类项目。在象棋竞技上，人类早早就被AI（广义上的，很原始的AI就够了）彻底击败了，但由于象棋的特性，AI的“高明”之处相对来说更容易被人类所理解，所以不论是与AI对弈，还是使用AI进行对局分析、观看AI对弈，都有一定的乐趣可言。</p>
<p>　　但是事情没这么简单。某天突发奇想，试图在自己的电脑上跑个象棋AI，这时候才发现，虽然个人电脑的算力完全足以运行先进的象棋AI（而且完全不需要GPU出手），但几乎所有的中国象棋软件都不开源，几乎所有会被windows报毒，几乎所有都不支持在虚拟机中运行，几乎所有都有收费版本，甚至有多个莫名其妙的收费层级。显然，这里的“几乎所有”是一种严谨而委婉的说法。结合从论坛看到的信息，我猜测这些软件的主要付费客群可能是在网络对弈中开挂的无聊人士，所以他们非常在乎在软件以外的其他界面上自动识别和自动行棋的能力，以及微小的棋力差距，而这些都不是我们想随随便便和AI下棋、看AI下棋的人关心的事。</p>
<p>　　一个稍有一点点技术常识的人能忍这些？我只好尝试完全基于开源方案的中国象棋，并且希望在Linux（实际上是WSL2）环境下运行，减少风险。本文就是关于这些实践的经验介绍。这些开源方案基本上都与国际象棋（Chess）相关软件有渊源，下文介绍时也将在一定程度上使用国际象棋相关的术语、引用与国际象棋相关的页面。</p>
<h2 id="相关术语">
    <a href="#%e7%9b%b8%e5%85%b3%e6%9c%af%e8%af%ad" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    相关术语
</h2>
<ul>
<li><a href="https://www.chessprogramming.org/Engines"><code>Engine</code></a>，which is the chess playing part of the chess program, relying on proprietary or standard protocols communicating with an external graphical user interfaces. 引擎是决定走法的部分，是“后端”。</li>
<li><a href="https://www.chessprogramming.org/GUI"><code>GUI</code></a>，Graphical User Interface (GUI), a user interface where interaction between user and a (chess) program takes place. 用户界面就是呈现棋盘、供用户操作（包括走棋和编辑棋局等）的“前端”。</li>
<li><a href="https://www.chessprogramming.org/Protocols"><code>Protocol</code></a>，a formal description of digital message formats and the rules for exchanging those messages in or between computing systems. 在象棋软件中，协议指的是前端界面和后端引擎之间联系的协议，通过约定协议，可以允许界面和引擎之间进行自由搭配（下文会提到，并非如此）,也有助于开发者只开发引擎或只开发界面，致力于自己感兴趣的部分。</li>
<li><a href="https://www.chessprogramming.org/Opening_Book"><code>Opening Book</code></a>，chess programs often look up the positions at the beginning of the game in an Opening Book. 开局库，让引擎根据一定的定势起手，减少开局阶段的运算量，提高开局速度，也可能在一定程度上提高棋力。基于我们的目的，本文不涉及开局库，你当然可以自己加载开局库。</li>
<li><a href="https://en.wikipedia.org/wiki/Chess_variant"><code>Chess variant</code></a>，指国际象棋的各类变种。这里有一点历史争论，国际上一般认为各种象棋都是源自一种印度的游戏——恰图兰卡，7世纪时流传至波斯成为波斯象棋，而波斯象棋传入中国成宝应象棋，最后中国人在宋代改造成象棋，换言之，中国象棋就是一种<code>chess variant</code>；但中国象棋界主张中国象棋是从春秋战国时期的“六博”演绎而来（以上两种观点均来自<a href="https://zh.wikipedia.org/wiki/%E8%B1%A1%E6%A3%8B">维基百科</a>）。折衷来说，<a href="https://en.wikipedia.org/w/index.php?title=List_of_chess_variants&amp;section=26#Chess-related_historical_and_regional_games">维基百科</a>将象棋归类为 &ldquo;Chess-related historical and regional games&rdquo;。抛开历史争论不谈，由于开发者一般这么认为，本文的语境中中国象棋与日本将棋、韩国将棋等一样，都是<code>chess variant</code>。</li>
<li><a href="https://www.chessprogramming.org/NNUE"><code>nnue</code></a>，Efficiently Updatable Neural Networks，a Neural Network architecture intended to replace the evaluation of Shogi, chess and other board game playing alpha-beta searchers running on a CPU. NNUE是一种神经网络，能够减少计算量、提升引擎的棋力。</li>
<li><a href="https://www.chessprogramming.org/Forsyth-Edwards_Notation"><code>FEN</code></a>，Forsyth-Edwards Notation，以字符串表示棋局的方式。</li>
</ul>
<h2 id="可用的开源方案">
    <a href="#%e5%8f%af%e7%94%a8%e7%9a%84%e5%bc%80%e6%ba%90%e6%96%b9%e6%a1%88" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    可用的开源方案
</h2>
<h3 id="引擎">
    <a href="#%e5%bc%95%e6%93%8e" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    引擎
</h3>
<p>　　上文提到“几乎所有”中国象棋软件都不开源，但其中的部分将引擎以二进制形式发布出来，但我不想讨论，也不想提到他们的名字。</p>
<p>　　近年正在开发的开源的引擎主要包括两个：<a href="https://github.com/fairy-stockfish/Fairy-Stockfish"><code>Fairy-Stockfish</code></a>和<a href="https://github.com/official-pikafish/Pikafish"><code>Pikafish</code></a>，两者都自称脱胎于著名的国际象棋引擎<a href="https://github.com/official-stockfish/Stockfish"><code>Stockfish</code></a>，前者是一个致力于多种chess variant且支持多种协议的大而全的引擎，国内有人翻译为“仙鱼”；后者是中国人开发的专用于中国象棋的引擎，中文名为“皮卡鱼”。一般而言，公认Pikafish比Fairy-Stockfish的棋力要强一些，近期的开发也更积极。当然，对于我们的目的而言，棋力的微小差距并不那么重要。</p>
<p>　　有一个古老的开源引擎<a href="https://github.com/xqbase/eleeye/tree/master">象眼</a>，近年还有微小的更新，我没有尝试，有兴趣的人可以自己研究看看。</p>
<h3 id="界面">
    <a href="#%e7%95%8c%e9%9d%a2" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    界面
</h3>
<p>　　界面是“几乎所有”中国象棋软件的重灾区，研发个引擎不行，研发个（骗钱或挂马的）界面还是不难的。还是那句话，我不想讨论，也不想提到他们的名字。</p>
<p>　　目前支持中国象棋的开源界面主要有两个：<a href="https://www.gnu.org/software/xboard/"><code>XBoard</code></a>和<a href="https://github.com/ml-research/liground"><code>LiGround</code></a>。前者从上古时代延续至今（可考的最早发布时间为1991年，最新版4.9.1发布于2016年），功能强大，一切基本上都可以定制，也可以在图形界面上直接编辑棋局。后者的目标是 &ldquo;modern Chess Variant Analysis GUI for the 21st century&rdquo;，界面更好看（见仁见智），只能使用FEN编辑棋局，现在还在更新，但不能算处于积极开发状态。</p>
<p>　　其他主流国际象棋界面大多明确表示没有支持variant的计划，或者没有支持中国象棋的计划，例如<a href="https://github.com/pychess/pychess"><code>pyChess</code></a>。目前最接近支持中国象棋的界面是<a href="https://github.com/cutechess/cutechess"><code>Cute Chess</code></a>,有一个<a href="https://github.com/cutechess/cutechess/pull/565">PR</a>支持中国象棋，但没有被合并。</p>
<p>　　请注意在WSL2中使用图形界面（也就是WSLg），需要一些技巧和设置，比如你需要遵循<a href="https://learn.microsoft.com/zh-cn/windows/wsl/tutorials/gui-apps">微软的指引</a>，你的发行版可能会对WSLg有特定的安排（比如<a href="https://en.opensuse.org/openSUSE:WSL#Enabling_GUI_support_(WSLg)">OpenSUSE的</a>）,你可能遇到问题（比如我就遇到重启后<code>cannot open display: :0</code>的问题）需要<a href="https://github.com/microsoft/wslg/wiki/Diagnosing-%22cannot-open-display%22-type-issues-with-WSLg">解决方法</a>。具体请自行摸索。</p>
<h3 id="协议">
    <a href="#%e5%8d%8f%e8%ae%ae" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    协议
</h3>
<p>　　与中国象棋有关的协议主要包括<a href="https://www.chessprogramming.org/Chess_Engine_Communication_Protocol"><code>CECP</code></a>，<a href="https://www.chessprogramming.org/UCI"><code>UCI</code></a>和<a href="https://www.xqbase.com/protocol/cchess_ucci.htm"><code>UCCI</code></a>,其中CECP主要是xboard及其windows衍生版本winboard在用，它们也只支持这一种协议（其他协议可以通过工具转换），所以该协议也被很多程序称为xboard协议；UCI是使用最广泛的国际象棋协议，中国象棋在使用的时候如果处理不当会有兼容性问题（下文会提到）；UCCI是专为中国象棋制定的协议，几乎没有开源界面支持（这里的几乎还是一种严谨而委婉的说法）。Pikafish只支持UCI协议，而Fairy-Stockfish支持CECP/UCI/UCCI协议。</p>
<h2 id="实际使用">
    <a href="#%e5%ae%9e%e9%99%85%e4%bd%bf%e7%94%a8" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    实际使用
</h2>
<p>　　从上文可以看出，我们基本上只有两种引擎、两种界面可用，他们组合起来分别有以下技巧和问题：</p>
<h3 id="xboardfairy-stockfish">
    <a href="#xboardfairy-stockfish" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    XBoard&#43;Fairy-Stockfish
</h3>
<p>　　一般的发行版都带有XBoard包（我用的是OpenSUSE的包），默认没有提供中国象棋棋盘和棋子，如果你安装的版本也是这样，那么可以在<a href="https://github.com/Kadagaden/chess-pieces">Kadagaden/chess-pieces</a>或者其他地方下载棋盘和棋子，然后在XBoard中打开<code>View - Edit Theme List...</code>，添加形如这样的配置（注意坑点：路径写<code>~</code>不能识别，也没有报错；写<code>~~</code>指的是安装路径，例如<code>/usr/share/games/xboard</code>），然后在<code>View - Board...</code>中双击<code>gmchess</code>就可以使用相应棋盘和棋子配置了（如果你棋盘显示不正常，根据下一步加载引擎后就会正常了）：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ini" data-lang="ini"><span class="line"><span class="cl"><span class="na">&#34;gmchess&#34; -ubt true -lbtf &#34;/home/you/xboard/gmchess_wood/xiangqi_gmchess_wood.png&#34; -dbtf &#34;/home/you/xboard/gmchess_wood/xiangqi_gmchess_wood.png&#34; -lbtm 1 -dbtm 1 -lsc #C8C365 -dsc #77A26D -ub false -upf false -pid &#34;/home/you/xboard/gmchess_wood&#34; -trueColors true -hsc #FFFF00 -phc #FF0000 -overrideLineGap 0</span>
</span></span></code></pre></div><p>　　你需要在<a href="https://github.com/fairy-stockfish/Fairy-Stockfish-NNUE/releases">fairy-stockfish/Fairy-Stockfish-NNUE</a>而不是<a href="https://github.com/fairy-stockfish/Fairy-Stockfish/releases">fairy-stockfish/Fairy-Stockfish</a>下载最新版的引擎（引擎已经内置nnue文件），前者最新版是<a href="https://github.com/fairy-stockfish/Fairy-Stockfish-NNUE/releases/tag/xiangqi-aa162e1771e5">2023年1月的</a>，比后者的<a href="https://github.com/fairy-stockfish/Fairy-Stockfish/releases/tag/fairy_sf_14_0_1_xq">2021年11月</a>要新；记得要下载标着xiangqi或者largeboard的版本。</p>
<p>　　Fairy-Stockfish支持CECP协议，所以只需要在XBoard的<code>Engine - Edit Engine List...</code>中添加形如这样的配置，然后在<code>Engine - Load New 1st Engine</code>的界面中双击<code>Fairy-Stockfish</code>就可以调入引擎了（同样注意路径的坑，这里用<code>-fd</code>指定工作目录的方法不可以用于上面的Theme List：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ini" data-lang="ini"><span class="line"><span class="cl"><span class="na">&#34;Fairy-Stockfish&#34; /variant</span><span class="o">=</span><span class="s">xiangqi -fcp &#34;./fairy-stockfish-largeboard_x86-64-bmi2&#34; -fd &#34;/home/you/xboard/fairy-stockfish&#34;</span>
</span></span></code></pre></div><p>　　如果加载后XBoard崩溃跳出，可以尝试加载一下其他象棋引擎（也就是Pikafish了）再加载Fairy-Stockfish。</p>
<p>　　XBoard的<code>Engine - Common Settings...</code>中可以调整一些与引擎有关的设置，<a href="https://github.com/official-pikafish/Pikafish/wiki/Pikafish-FAQ#optimal-settings">Pikafish建议</a>把CPU数设高，Hash-Table设高（达到1-2GB）。XBoard的<code>Engine - Engine #1 Settings</code>里面还有具体引擎的设置，<a href="https://github.com/official-pikafish/Pikafish/wiki/Pikafish-FAQ#optimal-settings">Pikafish建议</a>把MultiPV设成1。</p>
<p>　　然后你执红走一步，引擎就会执黑走棋了。如果没有加载开局库，一开始几步棋会很慢，可以通过引擎输出界面看看它在做什么。当然你也可以不走棋，使用<code>Mode - Two Machines</code>让引擎对弈（需要加载1st和2nd引擎）。你还可以在<code>Mode - Edit Position</code>状态下编辑棋局，用左键拖动棋子，右键修改棋子（点击后向不同方向拖动右键可以改变棋子内容，滚轮也可以）；编辑完之后选择Mode（例如Machine Black）就可以开始下棋了，如果XBoard报告&quot;It&rsquo;s not black&rsquo;s turn&quot;之类的，那么你要操作另一方先走一步再点击相应Mode。</p>
<h3 id="xboardpikafish">
    <a href="#xboardpikafish" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    XBoard&#43;Pikafish
</h3>
<p>　　XBoard的部分与上一节相同，而引擎的部分有所区别。</p>
<p>　　虽然Pikafish的各个版本可以从<a href="https://github.com/official-pikafish/Pikafish/releases">official-pikafish/Pikafish</a>中轻易获得，但是它并没有像Fairy-Stockfish一样集成nnue文件，不同版本的引擎不可换用其他版本的nnue文件。而除了最新版本对应的nnue文件可以从<a href="https://github.com/official-pikafish/Networks">official-pikafish/Networks</a>下载到以外，其他版本的nnue文件是没有官方途经可下载的（official-pikafish/Networks中只有一个release，但每当有新的nnue，作者就会更新这个release并删掉旧的文件，理由不明）。你需要把引擎文件和nnue文件放到同一个目录，两者的文件名最好相同（例如pikafish和pikafish.nnue）以便自动调用。</p>
<p>　　Pikafish不支持CECP协议，你需要使用<a href="https://www.chessprogramming.org/UCI2WB"><code>uci2wb</code></a>(意思是UCI to Winboard)程序来转换。关于uci2wb的介绍到处都有，但是源码和二进制程序有一点难找……<a href="http://hgm.nubati.net/cgi-bin/gitweb.cgi">作者网站上的源码</a>打不开，有人提供了一份可能不是最新的源码在<a href="https://github.com/ianfab/uci2wb">ianfab/uci2wb</a>，我是从<a href="https://packages.ubuntu.com/noble/uci2wb">Ubuntu的包</a>里面获得二进制程序的。在XBoard中这样设置引擎：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ini" data-lang="ini"><span class="line"><span class="cl"><span class="na">&#34;Pikafish&#34; /variant</span><span class="o">=</span><span class="s">xiangqi -fcp &#34;./uci2wb ./pikafish-bmi2&#34; -fd &#34;/home/you/xboard/pikafish&#34;</span>
</span></span></code></pre></div><p>　　也许你觉得XBoard有个-fUCI参数，加载引擎的界面上也可以选UCI，不是能直接用么？实际上这个参数会调用比uci2wb更古老的一个转换器polyglot，而它和uci2wb一样不是XBoard自带的，需要去找，还不如直接用uci2wb，因此上面的设置实际上等价于</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ini" data-lang="ini"><span class="line"><span class="cl"><span class="na">&#34;Pikafish&#34; /variant</span><span class="o">=</span><span class="s">xiangqi -fUCI -adapterCommand &#34;./uci2wb ./pikafish-bmi2 &#34;%fd&#34;&#34; -fd &#34;/home/you/xboard/pikafish&#34;</span>
</span></span></code></pre></div><p>　　uci2wb这个协议转换器带来一个重要的问题：XBoard与Pikafish连用时，无法支持残局，使用残局开局会崩溃跳出。个人推测可能是uci2wb并没有把初始局面正确告知引擎，技术水平有限无法分析代码，只能猜测了。</p>
<h3 id="ligroundfairy-stockfish">
    <a href="#ligroundfairy-stockfish" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    Liground&#43;Fairy-Stockfish
</h3>
<p>　　Liground内置了三个引擎（包含了某个版本的Fairy-Stockfish，所以你不下载引擎也可以），你可以把自己下载的Fairy-Stockfish放到<code>./resources/engines/</code>目录下去替换相应文件。
　　在界面中，左边选择棋盘和棋子的样式，右上区域的下拉框选择<code>Xiangqi</code>，然后引擎的下拉框就只有支持中国象棋的引擎可选了。你可以通过界面上的FEN栏来编辑局面。界面上打开PVE开关，并且把引擎后面的启用开关也打开，就可以与AI对弈了。可惜的是，Liground并不支持两个引擎对弈，虽然可以添加和删除引擎，但多个引擎只会对下一步的可能性进行分析，并不会行棋。
　　</p>
<h3 id="ligroundpikafish">
    <a href="#ligroundpikafish" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    Liground&#43;Pikafish
</h3>
<p>　　这是最麻烦的一套组合，因为Pikafish虽然支持UCI协议，但棋盘编号、UCI option等方面与Liground并不兼容。根据<a href="https://github.com/ml-research/liground/issues/261">Liground</a>和<a href="https://github.com/official-pikafish/Pikafish/issues/40">Pikafish</a>两边的issue，你需要使用修改了代码的Pikafish。<a href="https://github.com/mtaktikos/Pikafish/tree/liground-compatible">mtaktikos/Pikafish</a>是一个修改后的230216版，但是你很可能没法找到230216版Pikafish对应的nnue文件……所以我根据mtaktikos的工作照抄了一个231203版的，在<a href="https://github.com/williamgateszhao/Pikafish/tree/liground">williamgateszhao/Pikafish</a>，release中附上了231203版Pikafish对应的nnue文件。</p>
<h2 id="结论">
    <a href="#%e7%bb%93%e8%ae%ba" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    结论
</h2>
<p>　　完全使用开源方案跑中国象棋还挺麻烦的……这可能和中文软件开发的恶劣环境有关，我不想多说。</p>
<ul>
<li>如果你只是想和轻易碾压你的AI下棋，你可以使用以上四种组合中的任意一种，其中Liground+Fairy-Stockfish可能是相对简单的方案。</li>
<li>如果你想使用残局与AI对弈，你可以选XBoard+Fairy-Stockfish，Liground+Pikafish或Liground+Fairy-Stockfish。</li>
<li>如果你想让两个AI对弈，你可以用XBoard+Pikafish或XBoard+Fairy-Stockfish。使用不同版本的引擎，让他们对弈也挺有乐趣的，也许还能学习一下走法。</li>
<li>如果你想使用残局让两个AI对弈，你只能使用XBoard+Fairy-Stockfish。</li>
</ul>
<p>　　本文没涉及到的部分包括：</p>
<ul>
<li>XBoard有可能崩溃，除了本文提到的先载入Pikafish再载入Fairy-Stockfish（哪怕你只想载入后者）的技巧之外，还可能有其他情况、其他解决方案，请自行摸索。</li>
<li>Pikafish和Fairy-Stockfish引擎本身都有一些选项可以调整，我也没有形成经验，就不胡说了，你可以看他们各自的wiki自行摸索。</li>
<li>Pikafish制定了一个“<a href="https://pikafish.org/rule.pdf">中国象棋程序竞赛规则</a>”，这个规则和人类竞赛规则并不完全一样，越新版本的Pikafish越向这个规则靠拢，或者说逐步取消了一些符合人类竞赛规则的选项。这会导致其他引擎觉得合法的走法Pikafish认为是禁手，或者反过来Pikafish认为是合法的走法被XBoard认为是禁手（对于后一种情况也许可以调整XBoard的<code>Adjudications</code>界面中的选项），我的象棋水平太差没法具体分析，请自行摸索</li>
<li>通过不同的时间限制，也许可以让AI对弈更有趣，但引擎似乎不完全遵守时间限制（按照引擎公开的测试数据，它们应该是遵守的才对），可能是协议或界面的问题，请自行研究。</li>
</ul>

    </div>
</div>

<div class="container">
    
    <nav class="flex container suggested">
        
        <a rel="prev" href="/2024/04/use-whisper-to-generate-subtitles/" title="Previous post (older)">
            <span>Previous</span>
            使用whisper生成字幕的经验备忘
            </a>
        
        
        
    </nav>
    
</div>
 
<div class="container">
    
</div>

</main>


        </main>
        <footer class="footer flex">
    <section class="container">
        <nav class="footer-links">
            
        </nav>

        
    </section>
    <script defer src="/ts/features.f658accd96ff946aea04e7fca44a794f9632d32718aaf69be3f0f434b3ac6118.js" 
    data-enable-footnotes="true"
    ></script>
</footer>

    </body>
</html>